@Component
script GameManager extends Component

@Sync
property integer Gold = 0

@Sync
property integer Level = 1

@Sync
property integer exp = 0

@Sync
property integer stage = 1

@Sync
property integer highestStage = 1

@Sync
property integer floor = 1

@Sync
property integer highestFloor = 1

@Sync
property integer monstersKilledInFloor = 0

@Sync
property string floorState = "farming"

@Sync
property integer bossTimer = 0

@Sync
property boolean hasFailedBoss = false

@Sync
property boolean floorLocked = false

@Sync
property integer attackPower = 10

@Sync
property integer expToNextLevel = 100

@Sync
property number attackTimer = 0

@Sync
property number baseAttackInterval = 1

@Sync
property number attackSpeed = 0

@Sync
property number critChance = 5

@Sync
property number critDmg = 150

@Sync
property number goldBonus = 0

@Sync
property number dropRate = 0

@Sync
property string weapon = ""

@Sync
property string armor = ""

@Sync
property string gloves = ""

@Sync
property string boots = ""

@Sync
property string necklace = ""

@Sync
property string ring = ""

@Sync
property integer weaponEnhance = 0

@Sync
property integer armorEnhance = 0

@Sync
property integer glovesEnhance = 0

@Sync
property integer bootsEnhance = 0

@Sync
property integer necklaceEnhance = 0

@Sync
property integer ringEnhance = 0

@Sync
property integer upgradeCoins = 0

@Sync
property integer orbs = 0

@Sync
property integer skillPoints = 0

@Sync
property integer prestigePoints = 0

@Sync
property integer totalPrestiges = 0

@Sync
property integer relicFragments = 0

@Sync
property integer relicGachaCount = 0

@Sync
property string inventory = "[]"

@Sync
property string heroes = "{}"

@Sync
property string heroCards = "{}"

@Sync
property string collectionRareMonsters = "{}"

@Sync
property string collectionRareBosses = "{}"

@Sync
property string collectionLegendaryMonsters = "{}"

@Sync
property string collectionHeroes = "{}"

@Sync
property string collectionRelease = "{}"

@Sync
property string skillLevels = "{}"

@Sync
property string prestigeRelics = "{}"

@Sync
property string currentMonsterName = ""

@Sync
property integer currentMonsterHp = 0

@Sync
property integer currentMonsterMaxHp = 0

@Sync
property integer currentMonsterExp = 0

@Sync
property integer currentMonsterGold = 0

@Sync
property boolean currentMonsterIsBoss = false

@Sync
property boolean currentMonsterIsRare = false

@Sync
property boolean currentMonsterIsLegendary = false

@Sync
property number currentMonsterSpawnTime = 0

@Sync
property integer currentMonsterIndex = 0

@Sync
property boolean autoSellEnabled = false

@Sync
property string autoSellRarity = "common"

@Sync
property integer totalDamageDealt = 0

@Sync
property integer totalGoldEarned = 0

@Sync
property integer totalMonstersKilled = 0

@Sync
property integer totalBossesKilled = 0

@Sync
property integer totalItemsFound = 0

@Sync
property integer totalHeroCardsFound = 0

@Sync
property integer rareMonstersMet = 0

@Sync
property integer rareMonstersCaptured = 0

@Sync
property boolean worldBossActive = false

@Sync
property string worldBossData = "{}"

@Sync
property string auctionData = "{}"

@Sync
property string consumables = "{}"

@Sync
property number lastDailyRecharge = 0

@ExecSpace("ServerOnly")
method void OnBeginPlay()
	self:SpawnMonster()
end

@ExecSpace("ServerOnly")
method void OnUpdate(number delta)
	self.attackTimer = self.attackTimer + delta
	local realInterval = self.baseAttackInterval / (1 + self.attackSpeed / 100)
	if self.attackTimer >= realInterval then
		self.attackTimer = 0
		self:Attack()
	end
end

@ExecSpace("ServerOnly")
method void SpawnMonster()
	local floorData = self:GetFloorData(self.floor)
	local monsterIndex = math.random(1, 10)
	local monsterName = floorData.monsters[monsterIndex]
	local baseHp = self:GetMonsterHP(self.floor)
	local baseGold = baseHp

	self.currentMonsterName = monsterName
	self.currentMonsterHp = baseHp
	self.currentMonsterMaxHp = baseHp
	self.currentMonsterGold = baseGold
	self.currentMonsterIsBoss = false
	self.currentMonsterIsRare = false
	self.currentMonsterIsLegendary = false
	self.currentMonsterIndex = monsterIndex
	self.currentMonsterSpawnTime = os.time()
end

@ExecSpace("ServerOnly")
method void SpawnBoss()
	local floorData = self:GetFloorData(self.floor)
	local bossName = floorData.boss
	local bossHp = self:GetBossHP(self.floor)
	local bossGold = bossHp

	self.currentMonsterName = bossName
	self.currentMonsterHp = bossHp
	self.currentMonsterMaxHp = bossHp
	self.currentMonsterGold = bossGold
	self.currentMonsterIsBoss = true
	self.currentMonsterIsRare = false
	self.currentMonsterIsLegendary = false
	self.currentMonsterSpawnTime = os.time()
end

@ExecSpace("ServerOnly")
method void Attack()
	local damage = self.attackPower
	local isCrit = math.random(100) <= self.critChance
	if isCrit then
		damage = math.floor(damage * self.critDmg / 100)
	end

	self.currentMonsterHp = self.currentMonsterHp - damage
	self.totalDamageDealt = self.totalDamageDealt + damage

	if self.currentMonsterHp <= 0 then
		self:OnMonsterKill()
	end
end

@ExecSpace("ServerOnly")
method void OnMonsterKill()
	local goldEarned = math.floor(self.currentMonsterGold * (1 + self.goldBonus / 100))
	self.Gold = self.Gold + goldEarned
	self.totalGoldEarned = self.totalGoldEarned + goldEarned
	self.totalMonstersKilled = self.totalMonstersKilled + 1

	local expEarned = self:GetMonsterExp(self.floor)
	self.exp = self.exp + expEarned

	if self.exp >= self.expToNextLevel then
		self:LevelUp()
	end

	if self.currentMonsterIsBoss then
		self.totalBossesKilled = self.totalBossesKilled + 1
		self.monstersKilledInFloor = 0
		if not self.floorLocked then
			self.floor = self.floor + 1
			if self.floor > self.highestFloor then
				self.highestFloor = self.floor
			end
		end
		self.floorState = "farming"
		self:SpawnMonster()
	else
		self.monstersKilledInFloor = self.monstersKilledInFloor + 1
		local monstersNeeded = self:GetMonstersPerFloor()
		if self.monstersKilledInFloor >= monstersNeeded then
			self.floorState = "boss_ready"
			self:SpawnBoss()
		else
			self:SpawnMonster()
		end
	end
end

@ExecSpace("ServerOnly")
method void LevelUp()
	self.exp = self.exp - self.expToNextLevel
	self.Level = self.Level + 1
	self.expToNextLevel = self:CalculateExpToNextLevel(self.Level)
	self.skillPoints = self.skillPoints + 1
end

@ExecSpace("ServerOnly")
method integer GetMonsterHP(integer floorNum)
	local baseHP = 100
	return math.floor(baseHP * math.pow(1.05, floorNum - 1))
end

@ExecSpace("ServerOnly")
method integer GetBossHP(integer floorNum)
	local baseHP = 100
	local floorMultiplier = math.pow(1.05, floorNum - 1)
	return math.floor(baseHP * floorMultiplier * 20)
end

@ExecSpace("ServerOnly")
method integer GetMonsterExp(integer floorNum)
	local baseExp = 10
	return math.floor(baseExp * math.pow(1.03, floorNum - 1))
end

@ExecSpace("ServerOnly")
method integer CalculateExpToNextLevel(integer level)
	return math.floor(100 * math.pow(1.1, level - 1))
end

@ExecSpace("ServerOnly")
method integer GetMonstersPerFloor()
	return 10
end

@ExecSpace("ServerOnly")
method table GetFloorData(integer floorNum)
	local floorRanges = {
		[1] = {
			name = "버려진 광산",
			monsters = {"광산 박쥐", "동굴 쥐", "녹슨 골렘", "갱도 거미", "부서진 광부", "독가스 슬라임", "무너진 수레", "광석 정령", "곡괭이 좀비", "갱도 벌레"},
			boss = "폐광의 수호자",
			rareMonster = "황금 광석 골렘"
		},
		[6] = {
			name = "고블린 소굴",
			monsters = {"고블린 정찰병", "고블린 전사", "늑대기수", "고블린 투석병", "고블린 도적", "고블린 창병", "고블린 주술사 견습", "사냥개", "고블린 파수꾼", "고블린 광전사"},
			boss = "고블린 우두머리",
			rareMonster = "고블린 왕자"
		},
		[11] = {
			name = "거미 동굴",
			monsters = {"동굴 거미", "맹독 거미", "거미줄 덫꾼", "점프 거미", "알 수호자", "독침 거미", "어둠 거미", "거대 타란툴라", "거미 사냥꾼", "실뿜는 거미"},
			boss = "거대 여왕거미",
			rareMonster = "크리스탈 거미"
		},
		[16] = {
			name = "언데드 묘지",
			monsters = {"좀비", "스켈레톤", "그림자 영혼", "구울", "스켈레톤 궁수", "좀비 전사", "망령", "뱀파이어 박쥐", "해골 개", "부패한 시체"},
			boss = "묘지기 리치",
			rareMonster = "유령 기사"
		},
		[21] = {
			name = "코볼트 영토",
			monsters = {"코볼트 전사", "코볼트 주술사", "코볼트 암살자", "코볼트 창병", "코볼트 궁수", "코볼트 광부", "코볼트 정찰병", "코볼트 폭파병", "코볼트 사제", "코볼트 검사"},
			boss = "코볼트 대족장",
			rareMonster = "코볼트 영웅"
		},
		[26] = {
			name = "독버섯 숲",
			monsters = {"포자 좀비", "독버섯인간", "맹독 덩굴", "버섯 포자", "독초 정령", "썩은 나무인간", "독안개 정령", "맹독 슬라임", "포자 벌레", "균사체 괴물"},
			boss = "버섯왕 미코스",
			rareMonster = "발광 버섯"
		},
		[31] = {
			name = "하피 둥지",
			monsters = {"하피 전사", "깃털 마법사", "돌풍의 하피", "하피 궁수", "폭풍 하피", "하피 정찰병", "번개 하피", "하피 암살자", "회오리 하피", "하피 사냥꾼"},
			boss = "폭풍의 여왕",
			rareMonster = "번개의 하피"
		},
		[36] = {
			name = "미노타우로스 미궁",
			monsters = {"미로의 전사", "황소인간", "미궁 수호병", "투우사 미노타우로스", "도끼 미노타우로스", "미궁 파수꾼", "광전사 황소인간", "미로 순찰병", "뿔달린 전사", "미궁 광전사"},
			boss = "미로의 지배자",
			rareMonster = "황금 황소"
		},
		[41] = {
			name = "화염 용암지대",
			monsters = {"용암 슬라임", "화염 정령", "마그마 골렘", "불꽃 박쥐", "용암 벌레", "화염 악마", "불의 정령", "용암 거미", "화염 드레이크", "타오르는 해골"},
			boss = "불의 군주",
			rareMonster = "화염 피닉스"
		},
		[46] = {
			name = "얼음 동굴",
			monsters = {"서리 늑대", "빙결 좀비", "얼음 정령", "눈보라 정령", "빙하 골렘", "서리 거미", "얼음 드레이크", "냉기 유령", "눈사람 전사", "빙결 슬라임"},
			boss = "빙설의 마녀",
			rareMonster = "얼음 용"
		},
		[51] = {
			name = "오거 요새",
			monsters = {"오거 전사", "오거 타격수", "쌍두 오거", "오거 광전사", "오거 정예병", "오거 투척병", "철갑 오거", "오거 파괴자", "오거 사냥꾼", "오거 약탈자"},
			boss = "오거 장군",
			rareMonster = "삼두 오거"
		},
		[56] = {
			name = "다크엘프 거처",
			monsters = {"암흑 궁수", "그림자 암살자", "어둠 마법사", "다크엘프 검사", "독살자", "어둠 사제", "그림자 무용수", "암살단원", "어둠 주술사", "다크엘프 기사"},
			boss = "어둠의 여군주",
			rareMonster = "그림자 군주"
		},
		[61] = {
			name = "가고일 첨탑",
			monsters = {"석상 가고일", "비행 가고일", "석화의 감시자", "대리석 가고일", "화강암 가고일", "날개 달린 석상", "첨탑 파수꾼", "돌 악마", "석화 전사", "고딕 가고일"},
			boss = "고대의 가고일",
			rareMonster = "다이아몬드 가고일"
		},
		[66] = {
			name = "드래곤 둥지",
			monsters = {"와이번", "드레이크", "용인족 전사", "드래곤 새끼", "용비늘 전사", "불 드레이크", "용 사냥꾼", "드래곤 기사", "용인족 주술사", "익룡"},
			boss = "고룡 발라크",
			rareMonster = "엘더 드래곤"
		},
		[71] = {
			name = "악마의 전당",
			monsters = {"임프", "서큐버스", "헬하운드", "지옥 기사", "악마 사제", "인큐버스", "지옥 마법사", "악마 전사", "마귀", "지옥 창병"},
			boss = "지옥의 대공",
			rareMonster = "타락한 대천사"
		},
		[76] = {
			name = "정령의 심연",
			monsters = {"혼돈 정령", "폭주 원소", "차원 균열수", "공간 정령", "시간 정령", "무형 정령", "원소 융합체", "균열 악마", "뒤틀린 정령", "차원 포식자"},
			boss = "원소의 화신",
			rareMonster = "태초의 정령"
		},
		[81] = {
			name = "타락한 기사단",
			monsters = {"흑기사", "타락한 성기사", "망령 기사", "사신 기사", "타락 검사", "어둠 기사", "죽음의 기사", "타락한 십자군", "복수의 기사", "저주받은 기사"},
			boss = "타락의 기사단장",
			rareMonster = "파멸의 기사"
		},
		[86] = {
			name = "고대 유적",
			monsters = {"고대 골렘", "룬 수호자", "마법 파수꾼", "석판 골렘", "마법 석상", "고대 전사", "룬 정령", "마법진 수호자", "고대 마법사", "유적 골렘"},
			boss = "고대 마법사왕",
			rareMonster = "미스릴 골렘"
		},
		[91] = {
			name = "용의 무덤",
			monsters = {"본 드래곤", "드래곤 리치", "용혼의 파수꾼", "해골 용", "망령 와이번", "용 언데드", "용혼 전사", "뼈 드레이크", "용의 저주", "용혼 악령"},
			boss = "고룡의 망령",
			rareMonster = "죽음의 용"
		},
		[96] = {
			name = "심연의 끝",
			monsters = {"심연의 괴수", "공포의 화신", "혼돈의 군주", "어둠의 지배자", "공허의 포식자", "종말의 사자", "심연 악마", "절망의 괴물", "파멸의 화신", "무의 지배자"},
			boss = "심연의 지배자",
			rareMonster = "공허의 신"
		}
	}

	local rangeStart = math.floor((floorNum - 1) / 5) * 5 + 1
	if rangeStart > 96 then
		rangeStart = 96
	end

	local keys = {1, 6, 11, 16, 21, 26, 31, 36, 41, 46, 51, 56, 61, 66, 71, 76, 81, 86, 91, 96}
	local selectedKey = 1
	for i = #keys, 1, -1 do
		if rangeStart >= keys[i] then
			selectedKey = keys[i]
			break
		end
	end

	return floorRanges[selectedKey]
end

end


------------------------------------------------------------
-- UIGameHUD
------------------------------------------------------------

@Component
script UIGameHUD extends Component

property string gameManagerPath = "/World/GameSystem"
property Entity gameManager = nil

@ExecSpace("ClientOnly")
method void OnBeginPlay()
	self.gameManager = _EntityService:GetEntityByPath(self.gameManagerPath)
end

@ExecSpace("ClientOnly")
method void OnUpdate(number delta)
	if self.gameManager == nil then
		self.gameManager = _EntityService:GetEntityByPath(self.gameManagerPath)
		return
	end

	local gm = self.gameManager.GameManager
	if gm == nil then
		return
	end

	local goldText = self.Entity:GetChildByName("GoldText")
	if goldText ~= nil and goldText.TextComponent ~= nil then
		goldText.TextComponent.Text = tostring(gm.Gold) .. " G"
	end

	local levelText = self.Entity:GetChildByName("LevelText")
	if levelText ~= nil and levelText.TextComponent ~= nil then
		levelText.TextComponent.Text = "Lv." .. tostring(gm.Level)
	end

	local floorText = self.Entity:GetChildByName("FloorText")
	if floorText ~= nil and floorText.TextComponent ~= nil then
		floorText.TextComponent.Text = tostring(gm.floor) .. "층"
	end

	local monsterNameText = self.Entity:GetChildByName("MonsterNameText")
	if monsterNameText ~= nil and monsterNameText.TextComponent ~= nil then
		local prefix = ""
		if gm.currentMonsterIsBoss then
			prefix = "[BOSS] "
		end
		monsterNameText.TextComponent.Text = prefix .. gm.currentMonsterName
	end

	local monsterHpText = self.Entity:GetChildByName("MonsterHpText")
	if monsterHpText ~= nil and monsterHpText.TextComponent ~= nil then
		monsterHpText.TextComponent.Text = tostring(gm.currentMonsterHp) .. " / " .. tostring(gm.currentMonsterMaxHp)
	end
end

end
